# APFS
APFS在我折腾iOS 10的时碰到的一个新文件系统。
按照苹果一贯的风格，这个文件系统是不开源的，而且相关文档资料极少，使得我在提取文件系统时碰到了很大的困难。
但是这并不影响它有许多优越的新特性，正好又赶上N1CTF出题，于是就很有意思了。
调查之后发现，它有这些适合隐写的特性：

- Filesystem级别的snapshot机制
 >snapshot并不在file-level而是在更低的filesystem-level，隐蔽性更强

- 1-nanosecond级别的timestamp
- 增强的加密功能

## 题目思路
首先默认情况下ls的文件修改时间是只显示到分钟的，于是使得后面的许多位数据都是可以用来隐藏数据
接着呢为了增加隐蔽性，我们可以使用snapshot特性创造一层类似于图层的东西。
这样，这个challenge就完成了

## 出题思想
作为一个国际比赛，我在出题时坚决秉持**娱乐性**、**创新性**、**可解性**、**无脑洞**、**实际性**的原则，并希望选手可以通过这道题学到新的**知识、思路、方法、思想**。你可以在接下来的预期解法里面看出上面的原则。

## 预期解法
- 首先拿到一个dmg文件，尝试去挂载。可以立刻看到这个dmg是有密码保护的。而APFS的密码保护是AES-128/256，比赛又没有要求爆破密码，那说明密码肯定藏在某个地方
- dmg作为磁盘文件，去除文件头之后，必然是16bytes对齐的，而很显然提供的dmg并不是。string之后会出现可疑的AN1CTF_APFS，A是加密的数据中的，剩下的就是密码N1CTF_APFS
- 根据题目提示：** a bunch of new feature **，可以十分轻易的搜索到snapshot特性，那么自然是要找工具。选手们可以很轻易的搜索到Testing out APFS snapshot的文章，并找到文中说的snapshot.c和snapUtils。然而不管如何编译，最后都会出现Operation not permitted的错误。选手如果有Mac系统MAC框架的知识，并留意了网上的资料，可以猜测到是Entitlements没有被正确嵌入。
- 仔细阅读Testing out APFS snapshot文章，可以留意到作者在最后提到了apfs_snapshot这个小工具，这个是有Apple官方签名的，自然可以正常使用
- 但是在全新安装的High Sierra中是没有apfs_snapshot的。选手如果看到了reddit和Apple Support中的讨论可以得知在Sierra中这个工具是有的，而且拷贝之后可以正常工作。这样便可以看到并revert到ctf这个snapshot
- 如果在之前的搜索上仔细看了几篇文章，是可以留意nanosecond timestamp这个新特性的。mac自带的ls和stat没法处理nanosecond，brew下载coreutils，可以得到gls，gls一下之后便可以看到531个txt的最后三位都是有规律的00X。而且可以看到分布范围是000-007。敏锐的选手应该可以联想到是3bit的LSB。
- 提取LSB之后便可以发现是一个加密的ZIP文件，用之前的密码N1CTF_APFS便可以得到假flag
- 想到snapshot这个信息没有使用，按照同样方法提取3bit LSB，可以看到是00很多的相同长度的文件。考虑到两份数据长度相同、且第二份数据00较多，猜测是xor操作，便可得到第二个加密后的zip，继续用之前的密码N1CTF_APFS即可解出真实flag

## 题目评价
首先，APFS作为一个新兴的文件系统，资料**非常少**，这对于CTF选手来说是好事，因为这意味着这个题可能的考点受到非常大的限制，也就意味着选手可以更容易摸索到出题人的思路。
对于题目中使用到的信息，搜索apple apfs可以得到10篇左右介绍性的文章，在这些文章中便有介绍到snapshot、nanosecond这两个特性；搜索apfs snapshot，便可以得到介绍如何snapsuot的介绍性文章；仔细阅读后搜索apfs_snapshot的相关资料，便可以得到如何在新系统中使用apfs_snapshot的相关资料。
整道题用到的所有搜索结果都出现在Google前两页内。
而从上面的预期解题思路可以看出，这道题每一个level的难度逐步提升，并且需要较强的查找资料的能力，同时也需要选手具有专业敏感性。


## 关于Hint
有至少5个选手一直来烦我，要求我给hint。
而我考虑到某些选手实在太烦我放了一些hint，导致题目**考察点丧失了许多**。
我觉得这些选手需要端正自己的态度，
**并且希望某些选手在打比赛的时候多动动脑子，而不是盯着flag跟那里瞎猜。多动手、少bb，学会用Google**
